---
layout: main
title: MOTECH - Mobile Technology for Community Health
---

<div class="column-container clearfix">
  
  {% include modules/navigation.incl %}

  <div class="column five-sixths">
    <h3>Schedule Tracking Module</h3>

    <h3>Description</h3>
    <p>The schedule tracking module allows a client to be enrolled in a clearly defined schedule consisting of specified milestones. Milestones represent windows of time that a certain criteria, treatment, course, etc should be fulfilled before moving on to the next milestone. Alerts are sent to the enrolled clients when they are due, late or past on the period of fulfillment. Clients may be enrolled in unlimited schedules, but can only be active in one enrollment for given schedule.</p>

    <h3>Information for implementation</h3>

    <p>Schedules define a set of milestones that should be fulfilled in specified windows of time. Implementers can use the module to accomplish the following:</p>

    <ul>
      <li>Use a schedule tracking service that allows a specific client to be enrolled into a specific schedule for its duration</li>
      <li>Send alerts to clients that have been enrolled in a schedule</li>
      <li>Define JSON documents that specify a schedule and its set of milestones</li>
    </ul>

    <p>Enrollments are stored in CouchDB.</p>

    <h3>Specifying a schedule and its milestones</h3>
    <p>Specifying the characteristics of a schedule and its milestones is typically accomplished using a JSON (JavaScript Object Notation) document. The schedule_tracking.properties file specifies the directory to scan for schedule definitions. Any json file in the directory will be treated as a schedule definition. Multiple schedules can be defined, each in their own file. Schedules have a name and list of milestones. A milestone has a name, four standard windows, data (not currently used) and alerts. The window durations can be customized. Below is an example of a JSON schedule definition.</p>

    <h3>Sample Schedule Definition</h3>
    <p>Below is an example JSON definition file for a single schedule. The schedule has a name, IPTI Schedule. There are two distinct milestones specified within the schedule. The first, IPTI 1, will spend its first 13 weeks in waiting status called the "earliest" window. 1 week will be spent in in due status. (14 weeks is relative to start of milestone) Due to no maximum period being defined, as soon as the late period is entered, the enrollment's status will be set to defaulted. While the milestone is in due, one alert per day will be sent to the client at the preferred time they were enrolled with. Once in the late window, one alert per week is sent except for the first week. If no preferred time is passed, the alert will be raised exactly as per its offset from the reference date and time.</p>

    <p>Both milestones define data that is included in the alert event payload.</p>

    {% highlight javascript %}
{
    "name":"IPTI Schedule",
    "milestones":[
        {
            "name":"IPTI 1",
            "scheduleWindows":{
                "earliest":["13 Weeks"],
                "due":["14 Weeks"],
                "late":["2 Months"],
                "max":[""]
            },
            "data":{
                "Foo":"Bar"
            },
            "alerts":[
                {
                    "window":"due",
                    "offset":["0 Weeks"],
                    "interval":["1 Day"],
                    "count":"7"
                },
                {
                    "window":"late",
                    "offset":["1 Week"],
                    "interval":["1 Week"],
                    "count":"10"
                }
            ]
        },
        {
            "name":"IPTI 2",
            "scheduleWindows":{
                "earliest":["1 Weeks"],
                "due":["2 Weeks"],
                "late":["3 Weeks"],
                "max":[""]
            },
            "data":{
                "doo":"Bar"
            }
        }
    ]
}
    {% endhighlight %}


    <h3>Specifying Times</h3>

    <p>Time values in the schedule definition are speciied in the following format.
			number unit
		where, number is any number
		unit is any of year, month, week, day or hour. Plural form of the word can also be used. Note that durations involving year and month might not remain consistent. A month might have 28, 30 or 31 days, and a year may have 366 days. The actual duration will depend on the reference date around which the windows are defined.   		
		e.g: 1 Day, 4 Weeks
		
		Multiple time values can be combined together (as an array in the json) to result in a period which is a sum of all the values.
		e.g: ["2 Weeks", "3 Days"] reprents a period equivalent to 17 days,
			 
		An empty string normally means a zero duration. However, in the case a window is defined with an empty duration it DOES NOT mean the window has a zero offset from the start of the milestone. It simply means the window does not have a duration.
		
		Alert times can also be specified in a similar way. However, variable duration units such as month and year cannot be used. This is because our scheduling logic is very much rooted to fixed interval repeats. The behaviour in the case variable duration units are used for alerts is undefined. 
	</p>

    <h3>Enrolling a user in a campaign</h3>

    <p>The schedule tracking module exposes a ScheduleTrackingService with one method, enroll. To enroll a user in a schedule, an EnrollRequest must be passed to the enroll method in the service. EnrollRequests consist of the following information:</p>

    <dl>
      <dt>externalId (String)</dt>  <dd>A unique ID of the client.</dd>
      <dt>scheduleName (String)</dt>  <dd>The name of the schedule defined in the JSON document to be enrolled in.</dd>
      <dt>startingMilestoneName (String)</dt>  <dd>The name of the milestone in the schedule into which to directly enroll the user.</dd>
      <dt>referenceDate (LocalDate)</dt>  <dd>The date when the schedule starts for the user.</dd>
      <dt>referenceTime (Time)</dt>  <dd>optional time component can be specified for fine grained scheduling (defaults to midnight).</dd>
      <dt>enrollmentDate (LocalDate)</dt>  <dd>The date when the user is being enrolled into the schedule.</dd>
      <dt>enrollmentTime (Time)</dt>  <dd>optional time component can be specified for fine grained scheduling (defaults to midnight).</dd>
      <dt>preferredAlertTime (Time)</dt>  <dd>The time of day, in hours and minutes, the user should be sent alerts.</dd>
    </dl>

    <p>When enroll is invoked, the service determines whether that client is already enrolled and active in the schedule. If they are, the service overwrites the previous enrollment with the new one. An enrollment record for the user is created and added to the database. Jobs are scheduled for the current milestone, one per alert definition, to fire accordingly. Another job called a defaultment job is scheduled on the day the milestone would be defaulted to capture that state.</p>

    <h3>Events</h3>

    {% highlight java %}
    EventSubjects.MILESTONE_ALERT
    This event is emitted when an alert needs to be sent out and handled.
    Parameters/Payload:
	  external id 	
      schedule name 
	  window name
	  reference date and time
	  start dates for each of the four windows
    {% endhighlight %}


    <h3>Fulfilling milestones</h3>

    <p>Fulfills the current milestone the user is in the enrollment. After fulfillment of a milestone, the user moves to the next milestone in the schedule. If no more milestones remain the schedule, the enrollment is marked as complete.</p>

    <h3>Defaulted enrollments</h3>

    <p>For any milestone in an enrollment, if the milestone has not been fulfilled by the last day of the milestone then the enrollment will be marked as defaulted. The last day of the milestone is the day when all four windows of the milestone elapse. A defaulted enrollment will not raise any more alerts. It also cannot move to an active state (the default state of an enrollment that raised alerts).</p>

    <h3>Un-enrolling a user from a campaign</h3>

    <p>Removes a user from an active enrollment. Only active enrollments can be removed. The enrollment will be marked as Unenrolled. Defaulted or Completed enrollments are preserved in the database for record keeping.</p>

    <h3>Querying API</h3>

    <p>The module provides a search() method for querying enrollments. This allows the client to find enrollments using various critera (e.g all active enrollments, enrollments due in the next week etc). search() takes an EnrollmentQuery. The query can be built by adding search clauses such as enrollment status, current window etc. The clauses together will define a specific seatch criteria.
		
		Examples:		
		scheduleTrackingService.search(new EnrollmentsQuery().havingState("active"))

		will find all active enrollments		
				
		scheduleTrackingService.search(
			new EnrollmentsQuery()
				.havingSchedule("IPTI Schedule")
				.havingState("active")
				.havingWindowStartingDuring(WindowName.due, weeksAgo(1), now))
				
		will find active enrollments enrolled into IPTI Schedule that will enter the due window any time in the next one week.
	</p>

  </div>
</div>