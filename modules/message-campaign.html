---
layout: main
title: MOTECH - Mobile Technology for Community Health
---

<div class="column-container clearfix">

  
  {% include modules/navigation.incl %}

  <div class="column five-sixths">
    <h3>Message Campaign Module</h3>

    <h4>Description</h4>
    <p>The MOTECH message campaign module is used to enroll users into messaging campaigns. A user may be a patient, worker, lab, facility, or other desired recipient of the information to be disseminated. A campaign is a course of informational messages that are sent to the target user on an assigned date or schedule. A user can be entered into a campaign at any point during its duration via a Campaign Request. Users may be removed or re-enrolled into campaigns. The languages and formats of the campaign messages can be specified (IVR, SMS, English, etc). Campaign messages follow a clearly defined schedule and are automatically triggered by the scheduling system.</p>


    <h4>Information for implementation</h4>
    <p>Campaigns are for the dissemination of information defined by their campaign messages. There are four key concerns for end users:</p>

    <ul>
      <li>Defining the campaign's characteristics</li>
      <li>Starting or stopping a specific campaign message for a user, or stopping an entire campaign (all messages) for a user</li>
      <li>Providing the content for campaign messages</li>
      <li>Querying enrollments by a variable set of criterion (campaign name, external Id, status)</li>
    </ul>


    <h4>Configuration</h4>
    <p>The module provides its configuration in a messageCampaign.properties file. This file specifies the name and location of the JSON message campaign. This file also defines a strategy for providing client customization of message reminder times, which is explained in detail below in the discussion of REPEATING message campaigns.</p>
  
   <h4>Defining the campaign's characteristics</h4>
    <p>Specifying the characteristics of a campaign and its messages is typically accomplished using a JSON (JavaScript Object Notation) document. The messageCampaign.properties configuration file specifies the location and name of the JSON message campaign file. Campaigns have a name and type in addition to other fields depending on the message type.</p>

    <h4>Types</h4>
    <p>Campaigns contain a field for a type, which determines the type of message that will apply to the campaign. In a particular campaign, all campaign messages must be of the same campaign type. The module contains four different campaign types: absolute, cron based, offset, and repeating. All campaigns contain a field for the campaign name, campaign type, and a list of campaign messages. Each type of campaign has additional fields that correspond to its type specification. Each campaign message has the fields name, formats,  languages, and messageKey, along with additional fields depending on their campaign type.</p>

    <h5>Absolute Campaign</h5>
    <p>This type of campaign is specified as ABSOLUTE. Absolute campaign messages contain an additional field for the specific date in which to send the message, as they are only sent once. </p>

    {% highlight javascript %}
    {
      "name" : "Absolute Dates Message Program",
      "type" : "ABSOLUTE"
      "messages" : [
        {
          "name" : "First",
          "formats" : ["IVR", "SMS"],
          "languages" : ["en"],
          "messageKey" : "random-1",
          "date" : "2013-06-15"
        },
        {
          "name" : "Second",
          "formats" : ["IVR"],
          "languages" : ["en"],
          "messageKey" : "random-2",
          "date" : "2013-06-22"
        },
      ]
    }
    {% endhighlight %}

    <h6>Campaign Fields:</h6>

    <dl>
      <dt>name</dt> <dd>The name of the campaign. Campaign requests use this parameter to associate a user with a given campaign.</dd>
      <dt>type</dt> <dd>Specifies that this campaign is an absolute campaign.</dd>
      <dt>messages</dt> <dd>an array of messages of type ABSOLUTE.</dd>
    </dl>

    <h6>Messages Fields:</h6>
    <dl>
      <dt>name</dt> <dd>The name of the campaign message.</dd>
      <dt>formats</dt> <dd>The format(s) for the message, in this case, IVR and SMS.</dd>
      <dt>languages</dt> <dd>The language(s) for the message, in this case, en (English).</dd>
      <dt>messageKey</dt> <dd>A key uniquely identifying this message.</dd>
      <dt>date</dt> <dd>The date for this absolute message to be sent on.</dd>
    </dl> 

    <h5>Offset Campaign</h5>
    <p>This type of campaign is specified as OFFSET. Offset campaigns include an additional field: maxDuration. This field specifies the maximum duration of the campaign. Offset campaign messages contain the additional field timeOffset. The value of this field is determined by a message campaign scheduler. This scheduler specifies how many days or weeks from a specified reference date the job (message) will be scheduled. If no reference date is supplied, then the message campaign scheduler uses the current date as the reference date.</p>

    {% highlight javascript %}
    {
      "name" : "Relative Dates Message Program",
      "type" : "OFFSET"
      "messages" : [
        {
          "name" : "week 1",
          "formats" : ["IVR"],
          "languages" : ["en"],
          "messageKey" : "child-info-week-1",
          "timeOffset" : "1 week"
        },
        {
          "name" : "week 1A",
          "formats" : ["SMS"],
          "languages" : ["en"],
          "messageKey" : "child-info-week-1a",
          "timeOffset" : "1 week"
        },
        {
          "name" : "week 1A",
          "formats" : ["SMS"],
          "languages" : ["en"],
          "messageKey" : "child-info-week-1b",
          "timeOffset" : "9 days"
        },
      ]
    }
    {% endhighlight %}

    <h6>Campaign Fields:</h6>
    <dl>
      <dt>name</dt> <dd>The name of the campaign. Campaign requests use this parameter to associate a user with a given campaign.</dd>
      <dt>type</dt> <dd>Specifies that this campaign is an offset campaign.</dd>
      <dt>messages</dt> <dd>an array of messages of type OFFSET.</dd>
    </dl>

    <h6>Message Fields:</h6>
    <dl>
      <dt>name</dt> <dd>The name of the campaign message.
            formats The format(s) for the message, in this case, IVR or SMS, depending on the message.</dd>
      <dt>languages</dt> <dd>The language(s) for the message, in this case, en (English).</dd>
      <dt>messageKey</dt> <dd>A key uniquely identifying this message.</dd>
      <dt>date</dt> <dd>How long from the reference date to send the message.</dd>
    </dl>

    <h5>Repeating Campaign</h5>
    <p>This type of campaign is specified as REPEATING. Repeating campaigns also include the additional 
maxDuration field, which specifies the maximum duration in which the messages will be repeated. Repeating
 campaign messages contain the following additional message fields: repeatInterval, calendarStartOfWeek, weekDaysApplicable, 
and deliverTime. The repeat interval combined with the maximum duration determines how many messages will be scheduled. 
Week days determine which days of the week the messages will be sent at the time specified by the deliver time. A repeating message 
will always have the basic campaign message's fields (name, formats, languages, and messageKey) in addition to a combination of 
the additional fields defined above. A new message can be constructed in three ways:</p>
<dd>1) A repeat interval and a delivery time</dd>
<dd>2) A list of applicable week days and a delivery time</dd>
<dd>3) A known calendar start of week, a list of applicable week days, and a delivery time. </dd>
<br>
    {% highlight javascript %}
    {
      "name" : "Re1ative Parameterized Dates Message Program",
      "type" : "REPEATING",
      "maxDuration" : "5 weeks",
      "messages" : [
        {
          "name" : "week1y Message #1",
          "formats" : ["IVR", "SMS"],
          "1anguages" : ["en"],
          "messagekey": "chi1d-info-week-{offset}-1",
          "regeatInterval" : "1 week",
          "deliverTime" : "10:30"
        },
        {
          "name" : "week1y Message #2",
          "formats" : ["SMS"],
          "1anguages" : ["en"],
          "messagekey": "chi1d-info-week-{offset}-2",
          "regeatInterval" : "9 Days",
          "deliverTime" : "10:30"
        },
        {
          "name" : "week1y Message #3",
          "formats" : ["SMS"],
          "1anguages" : ["en"],
          "messagekey": "chi1d-info-week-{offset}-3",
          "regeatInterval" : "12 Days",
          "deliverTime" : "10:30"
        },
        {
          "name" : "week1y Message #4",
          "formats" : ["SMS"],
          "1anguages" : ["en"],
          "messagekey": "chi1d-info-week-{offset}-{weekDay}",
          "weekDaysApp1icab1e" : ["Monday", "wednesday", "Friday"],
          "deliverTime" : "10:30"
        },
        {
          "name" : "week1y Message #5",
          "formats" : ["SMS"],
          "1anguages" : ["en"],
          "messagekey": "chi1d-info-ca1endar-week-{offset}-{weekDay}",
          "calendarStartOfWeek" : "Sunday",
          "weekDaysApp1icab1e" : ["Monday", "Wednesday", "Friday"],
          "deliverTime" : "10:30"
        }
      ]
    }
    {% endhighlight %}

    <h6>Campaign Fields:</h6>
    <dl>
      <dt>name</dt> <dd>The name of the campaign. Campaign requests use this parameter to associate a user with a given campaign.</dd>
      type Specifies that this campaign is a repeating campaign.
      <dt>maxDuration</dt> <dd>This determines how long the repeating campaign is valid for. Messages will not be scheduled beyond this point.</dd>
      <dt>messages</dt> <dd>an array of messages of type REPEATING.</dd>
    </dl>
  
    <h6>Messages Fields:</h6>
    <dl>
      <dt>name</dt> <dd>The name of the campaign message.</dd>
      <dt>formats</dt> <dd>The format(s) for the message, in this case, SMS and/or IVR.</dd>
      <dt>languages</dt> <dd>The language(s) for the message, in this case, en (English).</dd>
      <dt>messageKey</dt> <dd>A key uniquely identifying this message.</dd>
      <dt>repeatInterval</dt> <dd>An interval that determines how many times a message is sent, based upon the maxDuration.</dd>
      <dt>deliverTime</dt> <dd>The time of day the message is delivered.</dd>
      <dt>weekDaysApplicable</dt> <dd>The days of the week the message will be sent.</dd>
      <dt>calendarStartOfWeek</dt> <dd>The day of week that should be used as start day of a week. Defaults to sunday if undefined. This value will affect the week number of the enrollment.</dd>
    </dl>

    <h6>Repeating strategy</h6>
	  <p>For repeating campaigns, it is possible to specify a deliverTime, i.e. the time at which the event will be raised. If there are a large number of enrollments in the system, a large number of events will have to be raised at the same time. This will add a significant load on the scheduler for that instant of time. To avoid this, a strategy can be enabled in messageCampaign.properties (24.hour.repeating.campaign.strategy). When enabled, the reminder time of the enrollment replaces the value of the deliverTime. This adds the feature that clients can customize their reminder times. Because different enrollments have different reminder times, the number of synchronous events will be reduced, therefore reducing the maximum load. </p>

    <h5>Cron-based Campaign</h5>
    <p>This type of campaign is specified as CRON. Each cron campaign message contains an additional field that identifies a cron expression. The cron expression determines the periodic schedule the messages will follow. </p>

    {% highlight javascript %}
    {
      "name" : "Cron based Message Program",
      "type" : "CRON",
      "messages" : [
        {
          "name" : "First",
          "formats" : ["IVR", "SMS"],
          "languages" : ["en"],
          "messageKey" : "cron-message",
          "cron" : "0 11 11 11 11 ?"
        }
      ]
    }
    {% endhighlight %}

    <h6>Campaign Fields:</h6>
    <dl>
      <dt>name</dt> <dd>The name of the campaign. Campaign requests use this parameter to associate a user with a given campaign.</dd>
      <dt>type</dt> <dd>Specifies that this campaign is a cron-based campaign.</dd>
      <dt>messages</dt> <dd>an array of messages of type CRON.</dd>
    </dl>

    <h6>Message Fields:</h6>
    <dl>
      <dt>name</dt> <dd>The name of the campaign message.</dd>
      <dt>formats</dt> <dd>The format(s) for the message, in this case, IVR and SMS.</dd>
      <dt>languages</dt> <dd>The language(s) for the message, in this case, en (English).</dd>
      <dt>messageKey</dt> <dd>A key uniquely identifying this message.</dd>
      <dt>cron</dt> <dd>A valid cron expression that specifies the scheduling of the messages.</dd>
    </dl>

    <h4>Enrolling a user into a campaign</h4> 
    <p>A campaign request associates a user (worker, patient, lab, etc.) with a unique campaign name, reference date, and reminder time. 
The campaign name determines which campaign will be retrieved or unscheduled from the JSON document. The reference date determines 
the calendar date that the campaign will begin for that user. If no reference date is supplied, then the current date upon enrollment is used 
in its place. The reminder time specifies what time of day in hours and minutes that the message will be sent. </p>

   <img src="/assets/modules/campaignrequest.PNG"/>
<p>  The message-campaign module exposes a MessageCampaignService interface with three methods that accept a Campaign Request 
object: startFor, stopFor, and stopAll. The startFor method creates an enrollment record for the request. It also schedules a campaign's 
message or messages as jobs in the scheduler. The stopFor method also accepts the unique key of the message to stop. This method 
unschedules one particular campaign message of the given campaign request. The stopAll method unschedules all campaign messages 
from the campaign. The search() method allows querying for enrollments and is discussed below.</p>
    

    <img src="/assets/modules/messagecampaignservice.png"/>

    <h4>Content</h4>
    <p>The content for messages is provided through the CMSlite module. </p>

    <h4>Example</h4>
    <p>Below is an example of a JSON document that includes two campaigns, each with a number of campaign messages. Each campaign object has three fields: name, type and an array of messages. Each message contains fields determined by their type. Campaign requests associate the user with these campaigns. A reference to the campaign's name, such as "Absolute Dates Message Program" must be included in the CampaignRequest. This allows the system to schedule jobs for the user based on the associated campaign. In the below example, if a user is enrolled in "Absolute Dates Message Program", two separate jobs (messages) will be scheduled. In the "Relative Parameterized Dates Message Program", twelve jobs will be scheduled for the user. The number of repeating messages is determined by the repeat intervals compared with the maximum duration. In the example below, Repeating Message #2 would have four scheduled messages due to a maximum duration of five weeks and repeat intervals of nine days. </p>

    {% highlight javascript %}
    [
      /* Absolute Campaign */
      {
        "name" : "Absolute Dates Message Program",
        "type" : "ABSOLUTE",
        "messages" : [         
          {
            "name" : "First Campaign Message",
            "formats" : ["IVR", "SMS"],
            "languages" : ["en"],
            "messageKey" : "random-1",
            "date" : "2013-06-15"
          },
          {
            "name" : "Second Campaign Message",
            "formats" : ["IVR"],
            "languages" : ["en"],
            "messageKey" : "random-2",
            "date" : "2013-06-22"            
          }
        ]
      },
      /* Repeating Campaign */  
      {
        "name" : "Relative Parameterized Message Program",
        "type" : "REPEATING",
        "maxDuration" : "5 weeks",
        "messages" : [
          {
            "name" : "Repeating Message #1",
            "formats" : ["IVR", "SMS"],
            "languages" : ["en"],
            "messageKey" : "child-info-week-{Offset}-1",
            "repeatInterval" : "1 Week"
          },
          {
            "name" : "Repeating Message #2",
            "formats" : ["SMS"],
            "languages" : ["en"],
            "messageKey" : "child-info-week-{Offset}-2",
            "repeatInterval" : "9 Days"
          },
          {
            "name" : "Repeating Message #3",
            "formats" : ["SMS"],
            "languages" : ["en"],
            "messageKey" : "child-info-week-{Offset}-3",
            "repeatInterval" : "12 Days"
          }
        ]
      }
    ]
    {% endhighlight %}

    <h3>Events consumed and emitted by the message campaign module</h3>

    <h4>Consumed events:</h4>
    <p>CampaignMessageHandler handles and consumes events with the key EventKeys.MESSAGE_CAMPAIGN_SEND_EVENT_SUBJECT</p>

    {% highlight java %}
    EventKeys.Message_CAMPAIGN_SEND_EVENT_SUBJECT (org.motechproject.server.messagecampaign.send-campaign-message)
    Parameters/Payload (originating from a CampaignRequest):
      EventKeys.CAMPAIGN_NAME_KEY (CampaignName)
      EventKeys.MESSAGE_KEY (MessageKey)
      EventKeys.SCHEDULE_JOB_ID_KEY (JobID)
      EventKeys.EXTERNAL_ID_KEY (ExternalID)
    {% endhighlight %}

    <br>
    <p>Upon completion of a campaign, the End Of Campaign Handler handles events with the key EventKeys.MESSAGE_CAMPAIGN_COMPLETED_EVENT_SUBJECT.</p>
   {% highlight java %}
    EventKeys.MESSAGE_CAMPAIGN_COMPLETED_EVENT_SUBJECT(org.motechproject.server.messagecampaign.campaign-completed)
    Parameters/Payload (originating from a CampaignEnrollment):
	EventKeys.ENROLLMENT_KEY (Enrollment)
	EventKeys.SCHEDULE_JOB_ID_KEY (JobID)
  {% endhighlight %}

    <h4>Emitted events:</h4>
   <p> CampaignMessageHandler emits events with the key EventKeys.MESSAGE_CAMPAIGN_FIRED_EVENT_SUBJECT after handling EventKeys.MESSAGE_CAMPAIGN_SEND_EVENT_SUBJECT.</p>

    {% highlight java %}
    EventKeys.Message_MESSAGE_CAMPAIGN_FIRED_EVENT_SUBJECT (org.motechproject.server.messagecampaign.fired-campaign-message)
    Parameters/Payload
      EventKeys.CAMPAIGN_NAME_KEY (CampaignName) - used to find the campaign message, from the CAMPAIGN_SEND_EVENT_SUBJECT event
      EventKeys.MESSAGE_KEY (MessageKey) - used from the CampaignRequest to find the message, from the CAMPAIGN_SEND_EVENT_SUBJECT event
      EventKeys.SCHEDULE_JOB_ID_KEY (JobID) - from the CAMPAIGN_SEND_EVENT_SUBJECT event
      EventKeys.EXTERNAL_ID_KEY (ExternalID) - user ID, from the CAMPAIGN_SEND_EVENT_SUBJECT event
      EventKeys.MESSAGE_NAME_KEY (MessageName) - retrieved from the campaign message name
      EventKeys.MESSAGE_FORMATS (MessageFormats) - list retrieved from the campaign message formats field
      EventKeys.MESSAGE_LANGUAGES (MessageLanguages) - list retrieved from the campaign message languages field
    {% endhighlight %}

<p>Upon completion of a campaign, the Message Campaign Scheduler emits events with the key 
EventKeys.MESSAGE_CAMPAIGN_COMPLETED_EVENT_SUBJECT.</p>

  {% highlight java %}
  EventKeys.Message_MESSAGE_CAMPAIGN_COMPLETED_EVENT_SUBJECT (org.motechproject.server.messagecampaign.campaign-completed)
  Parameters/Payload
	EventKeys.ENROLLMENT_KEY (Enrollment) - used to identify the Campaign Enrollment
	EventKeys.SCHEDULE_JOB_ID_KEY (JobID) - used to identify the ID of the job/event.
  {% endhighlight %}


    <h4>Additional information:</h4>

    <p>The message key uniquely identifies campaign messages (even repeating messages have their own unique message key). 
The external ID field of the Campaign Request is a user ID, identifying a patient, nurse, lab, facility, etc.

<p>The unique Job ID is a string constructed from EventKeys.BASE_SUBJECT, two fields from the campaign request: 
campaign name and external ID, and one field from the campaign message: messageKey.</p>

<p>As an example, if the campaign name is Campaign1, externalID is 123 and the message key is MessageKey4, then the 
Job ID would be: org.motechproject.server.messagecampaign.Campaign1.123.MessageKey4.</p>

<p>Note that some characteristics of a campaign message (for example, repeatInterval from repeating messages) 
are not sent as part of an event payload.</p>

    <p>Graphical representation of the event flow through the message campaign module:</p>

    <img src="/assets/modules/campaignmessageflow.png"/>

    <h4>Querying enrollments</h4> 
    <p>The module's Message Campaign Service, in addition to its capability to start, stop, or stop all message(s), is capable of searching Campaign Enrollment 
Records based on particular criteria provided by a Campaign Enrollments Query object. This  service's search() allows the client to query for enrollment records
 using various criteria: external ID, status, and/or campaign name. Queries are built by adding one or more of these criteria to the Campaign Enrollment 
Query's list of criteria. The clauses together define specific search criteria. The method returns a list of matching Campaign Enrollment Records.</p>

	<p>Examples:

	{% highlight java %}
	messageCampaignService.search(new CampaignEnrollmentsQuery().havingState(CampaignEnrollmentStatus.ACTIVE))
	{% endhighlight %}

	will find all active enrollments</p>

	{% highlight java %}
	messageCampaignService.search(
		new CampaignEnrollmentsQuery()
			.withCampaignName("My Program")
			.havingState(CampaignEnrollmentStatus.ACTIVE)
	{% endhighlight %}

	will find active enrollments enrolled into "My Program" campaign.
	</p>

<img src="/assets/modules/campaignenrollmentrecord.PNG"/>
<br>
<img src="/assets/modules/campaignenrollmentsquery.PNG"/>
	
    <h4>Questions for the message campaign module</h4>

    <p>It seems that the search() method of the Message Campaign Service could vary in performance based on the order of the criteria specified.
 Because each order of filtering will ultimately result in the same set, it seems there should be a recommended order in order to maximize 
performance. Would it be advisable that one initially specifies a query that would return the minimized subset of results (for example, 
query based on campaign name), and select further queries from this subset? Or should the query collect a larger subset first (for example, 
query based on enrollment status), and then become more narrow?</p>

<p>In addition, would an implementer ever have a reason to use the Campaign Enrollment Service directly to query for enrollments?</p>
  </div>
 </div>


