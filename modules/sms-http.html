---
layout: main
title: MOTECH - Mobile Technology for Community Health
---

<div class="column-container clearfix">

  {% include modules/navigation.incl %}

  <div class="column five-sixths">
    <h3> Module</h3> 

    <h4>Description</h4> 
<p>The SMS-HTTP module is an SMS implementation that helps to send and receive sms through HTTP via a specified SMS provider.</p>

    <h4>Information for implementation</h4> 
<p>The SMS-HTTP module should be deployed alongside the SMS-API module. An implementation should use the SMS service provided by the SMS-API module in order to send their messages. These message events are handled by the HTTP module. The HTTP module uses the Apache Commons HTTP Client to generate the HTTP requests. The implementer never directly calls this module. The callback url for handling incoming sms in sms provider should be set to the action handleIncoming of InboundSmsController (sms/inbound). This action triggers a motech event for every incoming sms. Templates must be specified for custom query parameters and the URI of the SMS provider. See configuration below.</p>
    <h4>Configuration</h4>
<p>An implementer must configure a sms-http-template.json file like the one found in the test resources folder. This file is responsible for providing the template information the module needs in order to generate the HTTP requests. An example template is provided below:</p>
{% highlight javascript %}
{
    "outgoing":{
        "request":{
            "urlPath":"http://smshost.com/sms/send",
            "queryParameters":{
                "recipient":"$numbers",
                "message":"$message",
                "apiKey":"jdhf7yelkjae"
            },
            "recipientsSeparator":"+"
        },
        "response":{
            "success":"sent"
        }
    },
    "incoming":{
        "messageKey": "$message",
        "senderKey": "$sender",
        "timestampKey": "$time"
    }
}

{% endhighlight %}
<h4>Outgoing</h4>
<p>In outgoing, $numbers and $message act as placeholders that are dynamically filled in when the message is generated.</p>
<p>queryParameters are appended to the request urlPath</p>
<p>The request field in the templates is used to generate the HTTP request. The response field is used to check the HTTP response. If the actual response does not contain the text found in the response field from the json template, an SmsDeliveryFailureException is thrown. Otherwise the message is considered sent.
</p>
<h4>Incoming</h4>
<p>messageKey, senderKey and timestampKey specify the request parameter sent by the provider that contains the message, sender and time at which message is received respectively. </p>
{% highlight javascript %}
{
    "outgoing": {
        "request": {
            "urlPath": "http://www.kookoo.in/outbound/outbound_sms.php",
            "queryParameters": {
                "phone_no": "$recipients" ,
                "message": "$message" ,
                "api_key": "******"
            }
        },
        "response": {
            "success": "<status>success</status>"
        }
    },
    "incoming": {
        "messagekey": "message",
        "senderKey": "from",
        "timestampKey": "time"
    }
}

{% endhighlight %}
<p> Here 'message', 'from', 'time' are keys used by kookoo for message, sender and time at which message is received. 
<h3>Events consumed and emitted by the SMS-HTTP module</h3>

    <h4>Consumed events:</h4></br>
{% highlight java %}
Subject: EventSubjects.SEND_SMS ("SendSMS")
Payload:
EventDataKeys.RECIPIENTS ("number") mapped to a List<String>
EventDataKeys.MESSAGE ("message") mapped to a String
EventDataKeys.DELIVERY_TIME ("delivery_time") mapped to a DateTime
{% endhighlight %}
This event will be emitted by the sms-api module. The HTTP module will send an sms to all the recipients with given message, both being defined in the payload of the event. In addition a delivery time can also be specified in which case the message will be scheduled to be sent out at the specified time.

    <h4>Emitted events:</h4>
{% highlight java %}
Subject: EventSubjects.INBOUND_SMS
Payload:
EventDataKeys.SENDER ("number") mapped to a String
EventDataKeys.INBOUND_MESSAGE ("message") mapped to a String
EventDataKeys.TIMESTAMP ("date") mapped to DateTime
{% endhighlight %}

<p>This event is emitted for an inbound sms. The payload contains the sender's number, the message text and the timestamp when the sender sent the message.</p>

    <h3>Questions</h3>
<p>Currently the SMS-HTTP module does not support authentication. See the campaign demonstration branch for a work around for simple authentication.
</p>
<p>
An implementation uses the SMS-API service to interact with the HTTP module. This means they cannot catch SmsDeliveryFailureExceptions that the HTTP module throws, because it is not in their calling thread of execution.
 </p>
 </div>
 </div>
